{% extends "./base.html" %}
{% block title %}
<title>Undertale France - Membres</title>
{% endblock %}
{% block content %}
{% load static %}
{% load bbcode_tags %}
{% load tz %}
{% load templatetags %}

{% include "./includes/_stats_header.html" %}
    <div class="homeListingSelectorV2">
        <a href="{% url 'archive:member-list' %}" class="sel" data-mode="" data-order="DESC"
            kajaxoptions="{&quot;noScrollTop&quot;:1}"><b>Inscrit le</b> <span class="sort-arrow">▼</span></a>
        <a href="{% url 'archive:member-list' %}?mode=posts&order=DESC" data-mode="posts" data-order="DESC"
            kajaxoptions="{&quot;noScrollTop&quot;:1}"><b>Messages</b> <span class="sort-arrow">▼</span></a>
        <a href="{% url 'archive:member-list' %}?mode=username&order=ASC" data-mode="username" data-order="ASC"
            kajaxoptions="{&quot;noScrollTop&quot;:1}"><b>Nom d'utilisateur</b> <span class="sort-arrow">▲</span></a>
        <a href="{% url 'archive:member-list' %}?mode=lastvisit&order=DESC" data-mode="lastvisit" data-order="DESC"
            kajaxoptions="{&quot;noScrollTop&quot;:1}"><b>Dernière visite</b> <span class="sort-arrow">▼</span></a>
    </div>

    <!-- Update active state of the listing selector based on URL (similar to _stats_header.html) -->
    <script>
        (function () {
            function updateMemberlistActive() {
                var container = document.querySelector('.homeListingSelectorV2');
                if (!container) return;

                var links = Array.prototype.slice.call(container.querySelectorAll('a'));
                links.forEach(function (a) { a.classList.remove('sel'); });

                var loc = new URL(window.location.href);
                var mode = loc.searchParams.get('mode');
                var order = loc.searchParams.get('order');

                // 1) Prefer matching by the `mode` query parameter
                if (mode) {
                    var modeMatch = links.find(function (a) {
                        try {
                            var u = new URL(a.href, loc.origin);
                            return u.searchParams.get('mode') === mode;
                        } catch (e) { return false; }
                    });
                    if (modeMatch) { 
                        modeMatch.classList.add('sel'); 
                        updateArrowDirection(modeMatch, order);
                        return; 
                    }
                }

                // 2) If no mode in URL, pick the link without a `mode` param
                var defaultMatch = links.find(function (a) {
                    try {
                        var u = new URL(a.href, loc.origin);
                        return !u.searchParams.get('mode');
                    } catch (e) { return false; }
                });
                if (defaultMatch) { 
                    defaultMatch.classList.add('sel'); 
                    updateArrowDirection(defaultMatch, order || 'DESC');
                    return; 
                }

                // 3) Fallback to first link
                if (links[0]) {
                    links[0].classList.add('sel');
                    updateArrowDirection(links[0], order || 'DESC');
                }
            }

            function updateArrowDirection(link, currentOrder) {
                var arrow = link.querySelector('.sort-arrow');
                if (arrow) {
                    if (currentOrder === 'ASC') {
                        arrow.textContent = '▲';
                    } else {
                        arrow.textContent = '▼';
                    }
                }
            }

            function toggleSortOrder(link, currentMode, currentOrder) {
                var linkMode = link.dataset.mode || '';
                
                // If clicking on the same mode, toggle the order
                if (currentMode === linkMode || (!currentMode && !linkMode)) {
                    var newOrder = currentOrder === 'ASC' ? 'DESC' : 'ASC';
                    
                    // Build new URL
                    if (linkMode) {
                        return '{% url "archive:member-list" %}?mode=' + linkMode + '&order=' + newOrder;
                    } else {
                        return '{% url "archive:member-list" %}?order=' + newOrder;
                    }
                }
                
                // If clicking on a different mode, use the default order for that mode
                return link.href;
            }

            // Enhanced click handler with order toggling
            document.addEventListener('click', function (e) {
                var container = document.querySelector('.homeListingSelectorV2');
                if (!container) return;
                var a = e.target.closest('a');
                if (!a || !container.contains(a)) return;
                
                e.preventDefault(); // Prevent default navigation
                
                var loc = new URL(window.location.href);
                var currentMode = loc.searchParams.get('mode') || '';
                var currentOrder = loc.searchParams.get('order') || 'DESC';
                
                var newUrl = toggleSortOrder(a, currentMode, currentOrder);
                
                // Update visual state immediately
                container.querySelectorAll('a').forEach(function (l) { l.classList.remove('sel'); });
                a.classList.add('sel');
                
                // Extract new order from URL for arrow update
                var newUrlObj = new URL(newUrl, window.location.origin);
                var newOrder = newUrlObj.searchParams.get('order') || 'DESC';
                updateArrowDirection(a, newOrder);
                
                // Navigate to new URL
                window.location.href = newUrl;
            }, true);

            window.addEventListener('popstate', updateMemberlistActive);
            document.addEventListener('DOMContentLoaded', updateMemberlistActive);
            updateMemberlistActive();
        })();
    </script>

    <style>
        .homeListingSelectorV2 a .sort-arrow {
            margin-left: 0.3em;
            font-size: 0.8em;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .homeListingSelectorV2 a:hover .sort-arrow {
            opacity: 1;
        }
        
        .homeListingSelectorV2 a.sel .sort-arrow {
            opacity: 1;
    </style>
        



        {% comment %} <script>jQuery('.afterMainHeader').remove();</script>

        <style>
            #mainheader {
                margin-bottom: 0;
            }
        </style>
        <script>
            jQuery('#mainheader').after(jQuery('#afterMainHeader'));
            jQuery('#afterMainHeader').attr('id', '').addClass('afterMainHeader');
        </script> {% endcomment %}


        {% comment %} <div class="homeListingSelectorV2">
            <a href="{% url 'archive:groups' %}" class="sel clickupdated" kajaxoptions="{&quot;noScrollTop&quot;:1}"
                onclick=""><b>Groupes</b></a>
            <a href="/memberlist.php?filter=badges" kajaxoptions="{&quot;noScrollTop&quot;:1}" class="clickupdated"
                onclick=""><b>Badges</b></a>
        </div> {% endcomment %}

        <div class="ibc">
            <div class="largeLeft" style="position: relative">
                <div class="bloc">
                    <div class="cattitle">Membres • {{count}}</div>
                    <div class="blocwrapper">

                        Les nouvelles personnes qui rejoindront ce forum apparaitront sur cette page<br><br>
                        {% comment %} <form method="get" action="memberlist.php?mode=username&amp;order=ASC" class="ucp_edit">
                            <div style="display: flex; width: 100%; gap: 1em;">
                                <input type="text" name="q" value="" placeholder="Rechercher un membre...">
                                <div class="submit-buttons" style="font-size: 0.8em; margin: 0; padding: 0">
                                    <input type="submit" value="Chercher" style="border-radius: 0.5em">
                                </div>
                            </div>
                        </form>
                        <br><br> {% endcomment %}

                        <div>



                            <div style="display: flex; width: 100%; gap: 2em; align-items: center">
                                <div style="flex: 1;font-weight: 900; font-size: 1.2em; line-height: 1.5em;">
                                    <div
                                        style="background-color: #; height: 1.2em; width: 1.2em; display: inline-block; border-radius: 2em; vertical-align: -0.2em; margin-right: 0.2em; borderx: 1px solid var(--var-tr-color-contrast-soft); overflow: hidden;">
                                        <div
                                            style="display: inline-block; height: inherit; width: inherit; background: linear-gradient(133deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.3) 100%);">
                                        </div>
                                    </div>

                                    <a href="{% url 'archive:member-list' %}" class="clickupdated" onclick="">Liste des membres</a><span style="opacity: 0.3"> • {{count}}</span>

                                </div>
                                <div>

                                </div>
                            </div>

                            <div class="membergroup">
                                <div>
                                {% for member in members %}

                                    <div class="listmembermain autoUserPopupAnchor">
                                        <div class="simpleBackgroundFocus"
                                            style="margin-left: calc(-1em - var(--padding-left-right-remove)); padding-left: calc(1em + var(--padding-left-right-remove)); margin-right: calc(0em - var(--padding-left-right-remove)); padding-right: calc(0em + var(--padding-left-right-remove))">
                                            <div style="font-size: 2em; position: relative;" class=""
                                                userid="{{member.id}}">
                                                {% if member.archiveprofile.profile_picture %}
                                                    <div class="avatar"
                                                        style="background-image: url({{ member.archiveprofile.get_avatar_url }}); cursor: pointer;">
                                                    </div>
                                                {% else %}
                                                    {% get_user_random_color username=member.username as random_color %}
                                                    <div class="avatar empty "
                                                        style="background-color: {{random_color}}; color: rgba(255, 255, 255, 0.9); cursor: pointer;">
                                                    {{ member.username|slice:":1"|upper }}</div>
                                                </a>
                                                {% endif %}

                                            </div>
                                            <div class="listmember">
                                                <div class="username"><a href="{% url 'archive:profile-details' member.id %}"
                                                        class="clickupdated"
                                                        userid="{{member.id}}"
                                                        style="position: relative;" onclick="">{{member.username}}</a></div>
                                                <div class="joined"><i class="fa-solid fa-user-plus"></i> <span
                                                        timestamp="{{member.date_joined|timestamp}}" title="{{member.date_joined}}">{{member.date_joined}}</span></div>
                                                <div class="visited">{% if member.archiveprofile.last_login|date:"Y-m-d" != "2000-01-01" %}<i class="fa-solid fa-eye"></i> <span
                                                        timestamp="{{member.archiveprofile.last_login|timestamp}}" title="{{member.archiveprofile.last_login}}">{{member.archiveprofile.last_login}}</span>{%endif%}</div>
                                                {% if member.archiveprofile.messages_count > -1 %}
                                                    <div class="posts">{{member.archiveprofile.messages_count}} <i class="fa-solid fa-comment"></i></div>
                                                {% else %}
                                                    <div class="posts">Inactif </div>
                                                {% endif %}
                                            </div>
                                            <div class="actions" style="width: 150px;">
                                                <div class="submit-buttons small round"
                                                    style="flex-wrap: nowrap; gap: 0.5em; justify-content: flex-end">


                                                    <button
                                                        style="cursor: not-allowed;"
                                                        onclick="return false"><i
                                                            class="fa-solid fa-fw fa-messages"
                                                            title="Envoyer un message"></i></button>

                                                    {% comment %} <button onclick="popupGift.open({'for_user_id': {{member.id}}});"><img
                                                            src="https://img.xooimage.com/files_lottie/certified-gift-xooit.svg"
                                                            style="height: 1.5em; vertical-align: -0.2em;"
                                                            title="Offrir un abonnement !"></button> {% endcomment %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                                </div>

                            </div>


                        </div>

                        {% include "./includes/_pagination.html" with pagination=pagination current_page=current_page max_page=max_page %}

                        {% comment %} <br>
                        <div class="submit-buttons" style="font-size: 0.8em; margin: 0; padding: 0">
                            <input type="button" onclick="kajaxdocumentlocationhref('/memberlist.php');" class="reset"
                                value="Retour" style="border-radius: 0.5em; width: 100%;">
                        </div> 
                        <br><br> {% endcomment %}

                    </div>
                </div>
            </div>
            <div class="smallRight">



                {% comment %} <div class="bloc blocpremium" onclick="showPremium()">
                    <div class="blocwrapper">
                        <div style="display: flex; align-items: center;justify-content: space-around;">
                            <div>
                                <div style="font-weight: 800; font-style: italic; font-size: 2.5em; margin-top: 0.4em;">
                                    PREMIUM</div>
                                <div style="font-style: italic; margin-top: 0.5em">3,99€ / mois</div>
                            </div>
                            <img src="https://img.xooimage.com/files_lottie/certified-xooit.svg"
                                style="float: right; height: 4.5em;">
                        </div>
                        <br>
                        <div style="text-align: center; margin-bottom: 1em; font-weight: 700;">

                            Devenez <span class="premium">Membre <b>Premium</b></span> de ce forum et profitez
                            d'incroyables avantages !

                        </div>
                    </div>
                </div> {% endcomment %}




                {% include "./includes/_who_is_online.html" %}



                <div class="bloc">
                    <div class="blocwrapper" style="font-size: 0.9em;">
                        <div class="ibc" style="color: var(--var-tr-color-contrast-soft); font-size: 0.95em;">
                            <div class="size tiers" style="text-align: center"><i
                                    class="fa-solid fa-bubble fa-ico-IMG_FORUM fa-ico-UNREAD"></i><br>Nouveaux messages
                            </div>
                            <div class="size tiers" style="text-align: center"><i
                                    class="fa-solid fa-bubble fa-ico-IMG_FORUM fa-ico-READ"></i><br>Pas de nouveaux
                                messages</div>
                            <div class="size tiers" style="text-align: center"><i
                                    class="fa-solid fa-bubble fa-ico-IMG_FORUM fa-ico-READ fa-ico-LOCKED"></i><br>Forum
                                Verrouillé</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- //--> <!-- ]]>"')}*/ //--><!--</script>--><!--//-->
        <script type="text/javascript"><!-
(function(){
var f = window.onresize || function(){};
window.onresize = function(){
document.cookie="ww=" + window.innerWidth + "; expires=Thu, 18 Dec 2026 12:00:00 GMT; path=/";
f();
};
document.cookie="ww=" + window.innerWidth + "; expires=Thu, 18 Dec 2026 12:00:00 GMT; path=/";
})();
-></script>
        <style>
            #vapi_product_image {
                display: none !important;
            }
        </style>
    </div>
</div>

{% endblock %}